<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ChatSQL Demo</title>
    <style>
      /* Use San Francisco / system font stack */
      body{font-family:-apple-system, "SF Pro Text", "SF Pro Display", "San Francisco", "San Francisco Text", "San Francisco Display", BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; margin:20px}
      #editor{width:100%;height:150px}
      table{border-collapse:collapse;margin-top:12px}
      th,td{border:1px solid #ddd;padding:6px}
      #ai-area{margin-top:20px}
      #chat{border:1px solid #ccc;padding:8px;height:200px;overflow:auto;background:#fafafa}
      .msg{margin:6px 0}
      .user{font-weight:600}
      .bot{color:#006}
    </style>
  </head>
  <body>
    <h2>ChatSQL Demo â€” Execute SQL</h2>

    <label>Exercise ID: <input id="exerciseId" type="number" value="1" style="width:60px"/></label>

    <div>
      <textarea id="editor" placeholder="Write your SELECT query here">SELECT id, name, dept FROM employees</textarea>
    </div>
    <div style="margin-top:8px">
      <button id="run">Run Query</button>
      <button id="loadMonaco">Load Monaco Editor</button>
    </div>

    <div id="result"></div>

    <div id="ai-area">
      <h3>AI Tutor (mock by default)</h3>
      <div id="chat"></div>
      <div style="margin-top:6px">
        <input id="aiInput" placeholder="Ask for help or paste error" style="width:70%" />
        <button id="aiSend">Ask AI</button>
      </div>
    </div>

    <script>
      async function runQuery(){
        const exId = document.getElementById('exerciseId').value || '1'
        const query = document.getElementById('editor').value
        const resDiv = document.getElementById('result')
        resDiv.textContent = 'Running...'

        try{
          const r = await fetch(`/api/exercises/${exId}/execute/`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body: JSON.stringify({query})
          })
          const data = await r.json()
          if(!data.success){
            resDiv.innerHTML = `<pre style="color:red">${data.error}</pre>`
            return
          }
          // render table
          const cols = data.columns || []
          const rows = data.rows || []
          let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead>'
          html += '<tbody>' + rows.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('') + '</tbody></table>'
          resDiv.innerHTML = html
        }catch(e){
          resDiv.innerHTML = '<pre style="color:red">'+e.toString()+'</pre>'
        }
      }

      document.getElementById('run').addEventListener('click', runQuery)

      // AI chat
      async function sendAI(){
        const exId = document.getElementById('exerciseId').value || '1'
        const msg = document.getElementById('aiInput').value
        if(!msg) return
        appendChat('You', msg)
        document.getElementById('aiInput').value=''
        const r = await fetch(`/api/exercises/${exId}/ai/`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({user_query: msg})
        })
        const j = await r.json()
        appendChat('AI', j.response)
      }

      function appendChat(who, text){
        const el = document.createElement('div'); el.className='msg'
        el.innerHTML = `<span class="${who==='You'?'user':'bot'}">${who}:</span> ${text}`
        document.getElementById('chat').appendChild(el)
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight
      }

      document.getElementById('aiSend').addEventListener('click', sendAI)
      document.getElementById('aiInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendAI() })

      // Load Monaco editor lazily
      document.getElementById('loadMonaco').addEventListener('click', async ()=>{
        if(window.monaco){ return }
        const loader = document.createElement('script');
        loader.src = 'https://unpkg.com/monaco-editor@0.41.0/min/vs/loader.js'
        loader.onload = () => {
          require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.41.0/min/vs' } });
          require(['vs/editor/editor.main'], function() {
            const ta = document.getElementById('editor')
            const value = ta.value
            ta.style.display='none'
            const div = document.createElement('div'); div.id='monaco'; div.style.height='250px'
            ta.parentNode.insertBefore(div, ta)
            window.monaco = monaco
            window.editor = monaco.editor.create(div, {value: value, language: 'sql', minimap:{enabled:false}})
          })
        }
        document.head.appendChild(loader)
      })

      // If Monaco editor is present when running query, get value from it
      document.getElementById('run').addEventListener('click', ()=>{
        if(window.editor){ document.getElementById('editor').value = window.editor.getValue() }
      })
    </script>
  </body>
</html>
